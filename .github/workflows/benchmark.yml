name: Benchmarks

on:
  pull_request_review:
    branches:
      - 'main'
    paths-ignore:
      - 'changelogs/**'
      - '**.md'
      - '.github/*.yml'
    types:
      [submitted]

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      # Benchmark the current ref
      - uses: actions/checkout@v2.3.4
      - uses: actions/setup-java@v2.1.0
        with:
          distribution: 'adopt'
          java-version: 11
      - name: Cache Gradle packages
        uses: actions/cache@v2.1.6
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-cache-${{ hashFiles('**/*.gradle.kts') }}
      - name: Benchmark PR
        run: bash ./gradlew mainBenchmark
      - name: Generate benchmark table
        uses: boswelja/kotlinx-benchmark-table-action@0.0.2
        id: pr-table
        with:
          benchmark-results: "benchmark/build/reports/benchmarks/main/*/main.json"

      # Benchmark the main branch
      - uses: actions/checkout@v2.3.4
        with:
          ref: 'main'
      - uses: actions/setup-java@v2.1.0
        with:
          distribution: 'adopt'
          java-version: 11
      - name: Cache Gradle packages
        uses: actions/cache@v2.1.6
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-cache-${{ hashFiles('**/*.gradle.kts') }}
      - name: Benchmark main
        run: bash ./gradlew mainBenchmark
      - name: Generate benchmark table
        uses: boswelja/kotlinx-benchmark-table-action@0.0.2
        id: main-table
        with:
          benchmark-results: "benchmark/build/reports/benchmarks/main/*/main.json"

      # Comment on the PR
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@1.0.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: |
            # Benchmarks

            ## Main
            ${{ steps.main-table.outputs.benchmark-table }}

            ## This PR
            ${{ steps.pr-table.outputs.benchmark-table }}
